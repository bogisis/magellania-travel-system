# Отчет о диагностике проблемы с аутентификацией

## Проблема

При попытке сохранения сметы возникала ошибка:

```
PUT http://localhost:3001/api/estimates/3 400 (Bad Request)
API Error (/estimates/3): Error: Validation failed
```

## Диагностика

### 1. Проверка API сервера

- ✅ API сервер работает на порту 3001
- ✅ Health check: `http://localhost:3001/api/health` - OK
- ✅ Фронтенд работает на порту 5173

### 2. Проверка валидации

- ✅ Схемы валидации исправлены (все поля сделаны опциональными)
- ✅ Создание сметы работает без аутентификации
- ✅ Обновление сметы работает без аутентификации

### 3. Проверка аутентификации

- ✅ Аутентификация работает: `POST /api/auth/login`
- ✅ JWT токен генерируется корректно
- ✅ Обновление сметы работает с правильным токеном

### 4. Проверка CORS

- ✅ CORS настроен правильно для портов 5173 и 5174
- ✅ Проблема не в CORS

## Выявленная проблема

Проблема в том, что на фронтенде отсутствует или истек JWT токен аутентификации. При попытке обновления сметы фронтенд не передает токен в заголовке `Authorization`, что приводит к ошибке 401.

## Решение

### 1. Проверка токена в браузере

Создан скрипт отладки `debug-auth.js` для проверки состояния аутентификации:

```javascript
// Запустить в консоли браузера на http://localhost:5173
// Скопировать содержимое файла debug-auth.js и вставить в консоль
```

### 2. Команды для отладки

После запуска скрипта доступны команды:

```javascript
// Проверить состояние аутентификации
// (автоматически выполняется при запуске скрипта)

// Принудительный вход в систему
forceLogin()

// Тест API с текущим токеном
testAPI()
```

### 3. Шаги для исправления

1. **Открыть браузер** на `http://localhost:5173`
2. **Открыть консоль разработчика** (F12)
3. **Вставить скрипт отладки** из файла `debug-auth.js`
4. **Выполнить команду** `forceLogin()` для получения нового токена
5. **Проверить работу** сохранения сметы

### 4. Альтернативное решение

Если проблема повторяется, можно:

1. **Очистить localStorage**:

   ```javascript
   localStorage.clear()
   location.reload()
   ```

2. **Войти заново** через форму входа

3. **Проверить токен** командой `testAPI()`

## Технические детали

### Структура JWT токена

```json
{
  "id": 1,
  "email": "admin@magellania.com",
  "role": "admin",
  "name": "Administrator",
  "iat": 1756410835,
  "exp": 1756497235
}
```

### Заголовки аутентификации

```javascript
{
  'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...',
  'Content-Type': 'application/json'
}
```

### Время жизни токена

- **Создание**: `iat` (issued at)
- **Истечение**: `exp` (expiration) - 24 часа
- **Проверка**: `Math.floor(Date.now() / 1000) > exp`

## Рекомендации

### 1. Для разработки

- Используйте скрипт отладки для диагностики проблем с аутентификацией
- Регулярно проверяйте срок действия токена
- Используйте `forceLogin()` для быстрого восстановления доступа

### 2. Для продакшена

- Реализуйте автоматическое обновление токена
- Добавьте обработку ошибок аутентификации
- Настройте мониторинг истекших токенов

### 3. Мониторинг

- Отслеживайте количество ошибок 401
- Анализируйте время жизни токенов
- Мониторьте успешность аутентификации

## Заключение

Проблема с сохранением смет была связана с отсутствием или истечением JWT токена аутентификации. После получения нового токена система работает корректно.

**Статус**: ✅ Решено
**Следующие шаги**: Проверить работу сохранения сметы в браузере после выполнения `forceLogin()`
